#!/usr/bin/env node

'use strict';

const spawn = require('child_process').spawn,
  inspect = require('util').inspect,
  repl = require('repl');

const pbcopy = data => {
  return new Promise((resolve, reject) => {
    const pbcopy = spawn('pbcopy')
      .on('exit', code => {
        code === 0 ? resolve() : reject(new Error(`pbcopy exited with status code ${code}`));
      })
      .on('error', reject);

    pbcopy.stdin.write(data);
    pbcopy.stdin.end();
  });
}

repl
  .start({ prompt: '> ' })
  .defineCommand('cp', {
    help: 'Copy last result to the clipboard',
    action: function () {
      const data = inspect(this.context._);

      pbcopy(data)
        .then(() => {
          this.displayPrompt();
        }, err => {
          console.log(`Error: ${err.message}`);
          this.displayPrompt();
        });
    }
  });
