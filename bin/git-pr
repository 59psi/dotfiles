#!/usr/bin/env bash -e
# git-pr: apply a GitHub pull request patch file to a new branch

if [[ -z $1 ]]
then
	git show-branch --list | grep -E --color=never "pr/[0-9]+"
	exit 0
fi

GIT_PR_ID=$(echo $1 | grep -Eo "[0-9]+")

upstream=$(git config --get pr.upstream || echo "upstream/master")

if [[ "$1" == "$GIT_PR_ID" ]]
then
	url=$(git config --get pr.url)/${GIT_PR_ID}
else
	url=$(echo $1 | grep -Eo ".+[0-9]+")
fi

export GIT_PR_ID

git checkout --detach ${upstream} 2> /dev/null
curl -# "${url}.patch" | git am -s -3
git checkout -b pr/${GIT_PR_ID}
