#!/bin/sh
# Apply a GitHub pull request to a new branch.
#
# Set the GitHub project url:	git config pr.url <url>
# Set the upstream remote:	git config pr.remote <remote>
# Set the upstream branch:	git config pr.branch <branch>
#
# GIT_PR_ID is exported so that it can be utilized by hooks
# that are invoked by the Git commands executed by the script.

set -e

if test -z "$1"
then
	git branch -v | grep -E --color=never "pr/[0-9]+"
	exit 0
fi

GIT_PR_ID=$(echo "$1" | grep -Eo "[0-9]+")
export GIT_PR_ID

remote=$(git config --get pr.remote)
branch=$(git config --get pr.branch)

if test "$1" = "$GIT_PR_ID"
then url=$(git config --get pr.url)/pull/$GIT_PR_ID
else url=$(echo "$1" | grep -Eo ".+[0-9]+")
fi

git checkout --detach "$remote/$branch" 2> /dev/null
curl -# "$url.patch" | git am -s -3
git checkout -b "pr/$GIT_PR_ID"
