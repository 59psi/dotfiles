#!/bin/sh

set -e

tmp=$(mktemp /tmp/$(basename $0).XXXXXX)
dir=$HOME/src/gists
netrc=$HOME/.netrc

uname=$(awk '/machine gist/ { print $4 }' $netrc)
token=$(awk '/machine gist/ { print $6 }' $netrc)

curl -# "https://api.github.com/users/$uname/gists?access_token=$token" -o "$tmp"

for id in $(sed -En 's/^[ ]{4}"id": "([a-fA-F0-9]{6,40})",$/\1/p' < "$tmp")
do
	if test -d "$dir/gist-$id"
	then git --git-dir=$dir/gist-$id/.git pull
	else git clone git@gist.github.com:$id.git "$dir/gist-$id"
	fi
done

unlink $tmp
