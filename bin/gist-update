#!/usr/bin/env bash -e
# update or clone public and private Gists to ~/src/gists

TMPLATE=$(basename $0)
TMPFILE=$(mktemp /tmp/${TMPLATE}.XXXXXX)
GISTDIR=${HOME}/src/gists

UNAME=$(awk '/machine github/ { print $4 }' ${HOME}/.netrc)
TOKEN=$(awk '/machine github/ { print $6 }' ${HOME}/.netrc)

curl -# "https://api.github.com/users/${UNAME}/gists?access_token=${TOKEN}" -o ${TMPFILE}

for id in $(sed -En 's/^[ ]{4}"id": "([a-fA-F0-9]{6,40})"$/\1/p' < ${TMPFILE})
do
	if [[ -d "${GISTDIR}/gist-${id}" ]]
	then
		cd ${GISTDIR}/gist-${id}
		git pull
	else
		git clone git@gist.github.com:${id}.git "${GISTDIR}/gist-${id}"
	fi
done
