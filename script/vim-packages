#!/bin/bash
set -eu

cd "$(git rev-parse --show-toplevel)"

time=$(date +"%Y-%m-%d %H:%M:%S %z")
manifest=vim/pack/manifest
packpath=vim/pack/bundle/start

install_or_update () {
  local repo=${1}
  local pkgdir="${packpath}/${repo##*/}"

  if [ ! -d "$pkgdir" ]; then
    printf "Installing %s\\n" "$repo"
    git clone --depth 1 "$repo" "$pkgdir"
  else
    printf "Updating %s\\n" "$pkgdir"
    git -C "$pkgdir" checkout -q master
    git -C "$pkgdir" pull -q --no-rebase --ff-only
    git -C "$pkgdir" --no-pager log --graph --decorate --oneline "master@{${time}}.."
  fi
}

update () {
  while read -r repo; do
    install_or_update "$repo"
  done < "$manifest"
}

prune () {
  find "$packpath" -mindepth 1 -maxdepth 1 -type d -exec git -C {} config --get remote.origin.url \; | while read -r repo; do
    if ! grep -q -F "$repo" < "$manifest"; then
      echo "Removing $repo"
      rm -r "${packpath}/${repo##*/}"
    fi
  done
}

generate_help_tags () {
  echo "Generating help tags"
  vim +helptags\ ALL +q
}

mkdir -p "$packpath"
update
prune
generate_help_tags
