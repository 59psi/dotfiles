#!/bin/sh
set -eu

cleanup() {
  status=$?
  trap - EXIT INT TERM
  ssh -qO exit git@github.com
  exit $status
}

cd "$(git rev-parse --show-toplevel)"

time=$(date +"%Y-%m-%d %H:%M:%S %z")

ssh -qfNM git@github.com
trap cleanup EXIT INT TERM

git submodule sync --recursive -q &&
git submodule update --init --recursive -q &&
git submodule foreach --recursive -q "
  echo \$path &&
  git checkout -q master &&
  git pull -q --no-rebase --ff-only &&
  git --no-pager log --graph --decorate --oneline 'master@{${time}}..'
"
