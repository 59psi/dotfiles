#!/usr/bin/env bash
set -eu

time=$(date +"%Y-%m-%d %H:%M:%S %z")
host=git@github.com
dir=$(mktemp -d -t "$host:22")
ssh_cmd="ssh -q -S $dir/sock"
export GIT_SSH_COMMAND=$ssh_cmd

cd "$(git rev-parse --show-toplevel)"

cleanup () {
  status=$?
  trap - EXIT INT TERM
  $ssh_cmd -O exit "$host"
  rmdir "$dir"
  exit $status
}

$ssh_cmd -fNM -o ControlPersist=yes "$host"
trap cleanup EXIT INT TERM

git submodule sync --recursive -q &&
git submodule update --init --recursive -q &&
git submodule foreach --recursive -q "
  echo \$path &&
  git checkout -q master &&
  git pull -q --no-rebase --ff-only &&
  git --no-pager log --graph --decorate --oneline 'master@{${time}}..'
"
