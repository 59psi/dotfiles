#!/bin/sh
set -eu

cleanup() {
  status=$?
  trap - EXIT INT TERM
  $ssh_cmd -O exit git@github.com
  rmdir "$dir"
  exit $status
}

cd "$(git rev-parse --show-toplevel)"

time=$(date +"%Y-%m-%d %H:%M:%S %z")
dir=$(mktemp -d -t git@github.com:22)
ssh_cmd="ssh -q -S $dir/sock"
export GIT_SSH_COMMAND=$ssh_cmd

$ssh_cmd -fNM -o ControlPersist=yes git@github.com
trap cleanup EXIT INT TERM

git submodule sync --recursive -q &&
git submodule update --init --recursive -q &&
git submodule foreach --recursive -q "
  echo \$path &&
  git checkout -q master &&
  git pull -q --no-rebase --ff-only &&
  git --no-pager log --graph --decorate --oneline 'master@{${time}}..'
"
