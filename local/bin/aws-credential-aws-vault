#!/usr/bin/env bash
set -eu

minutes=15
expiration=$(date -v+${minutes}M -u "+%FT%TZ")

aws-vault exec "$1" --session-ttl="${minutes}m" -- jq -n "
{
  Version: 1,
  AccessKeyId: env.AWS_ACCESS_KEY_ID,
  SecretAccessKey: env.AWS_SECRET_ACCESS_KEY,
  SessionToken: env.AWS_SESSION_TOKEN,
  Expiration: \"$expiration\"
}
" | jq "
if (.SessionToken | length) then
  .
else
  del(.Expiration)
end
"
