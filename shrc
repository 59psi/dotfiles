# vim:ft=sh
# shellcheck shell=sh

simplify_path () {
  # shellcheck disable=SC2039
  local IFS=: var=$1 dir val
  for dir in $2; do
    case ":$val:" in
      *:"$dir":*) ;;
      *) [ -d "$dir" ] && val=${val:+$val:}$dir ;;
    esac
  done
  eval "$var=\$val"
}

PKG_PREFIX=/usr/local
simplify_path PATH "$HOME/.local/bin:$PKG_PREFIX/bin:$PKG_PREFIX/sbin:/usr/bin:/bin:/usr/sbin:/sbin:$PATH"
simplify_path INFOPATH "$PKG_PREFIX/share/info:/usr/share/info:$INFOPATH"

export PATH INFOPATH

[ ! -x /bin/stty ] || stty -ixon

alias av="aws-vault"
alias du1="du -h -d1"
alias fkill="fuzzy-kill"
alias fps="fuzzy-ps"
alias grep="grep -In --color=auto --exclude-dir=.git --exclude=tags"
alias egrep="grep -E"
alias fgrep="grep -F"
alias helptags="vim +helptags\\ ALL +q"
alias lstcp="sudo lsof -Pn -iTCP"
alias lsudp="sudo lsof -Pn -iUDP"
alias pb="git for-each-ref refs/heads --format='%(refname:short)' | fzy | xargs git checkout"
alias pemcp="find ~/.ssh -name '*.pem' | fzy | xargs cat | pbcopy"
alias rg="rg --line-number --no-heading --hidden"
alias tf="terraform"
alias tree="tree -ACFIa .git --dirsfirst"
alias vi="vim"

sudo () {
  case "$1" in
  vi|vim)
    echo "use sudoedit or sudo -e" >&2
    return 1
    ;;
  *)
    command sudo "$@"
    ;;
  esac
}

_inpath () {
  type "$1" >/dev/null 2>&1
}

case "$(uname)" in
  Darwin)
    _inpath ggrep && alias grep="ggrep -In --color=auto --exclude-dir=.git --exclude=tags"
    _inpath sudoedit || alias sudoedit="sudo -e"

    alias ls="ls -AFGbh"
    alias flushdns="sudo -k killall -HUP mDNSResponder"
    alias resetlaunchpad="defaults write com.apple.dock ResetLaunchPad -bool true && killall Dock"
    alias resetls="/System/Library/Frameworks/CoreServices.framework/Frameworks/LaunchServices.framework/Support/lsregister -kill -r -v -apps u"
    alias bu="brew update && brew upgrade && brew cleanup -s --prune=0"

    mdopen () {
      mdfind "$@" | fzy | xargs -I{} open {}
    }

    COPYFILE_DISABLE=1
    export COPYFILE_DISABLE

    HOMEBREW_NO_EMOJI=1
    HOMEBREW_NO_ANALYTICS=1
    export HOMEBREW_NO_EMOJI HOMEBREW_NO_ANALYTICS
    ;;
  Linux)
    alias ls="ls -AFbh --color=auto"
    ;;
esac

packer () {
  docker run -it --rm \
    --log-driver none \
    --name packer \
    --mount "type=bind,src=$(pwd),dst=/work" \
    --workdir /work \
    -e AWS_ACCESS_KEY_ID \
    -e AWS_SECRET_ACCESS_KEY \
    -e AWS_SESSION_TOKEN \
    hashicorp/packer:light \
    "$@"
}

promtool () {
  docker run -it --rm \
    --log-driver none \
    --name promtool \
    --mount "type=bind,src=$(pwd),dst=/work,readonly" \
    --workdir /work \
    --entrypoint promtool \
    prom/prometheus:latest \
    "$@"
}

amtool () {
  docker run -it --rm \
    --log-driver none \
    --name amtool \
    --mount "type=bind,src=$(pwd),dst=/work,readonly" \
    --workdir /work \
    --entrypoint amtool \
    prom/alertmanager:latest \
    "$@"
}

pushgateway () {
  docker run -it --rm \
    --log-driver none \
    --name pushgateway \
    --publish 9091:9091 \
    prom/pushgateway:latest \
    "$@"
}

redis-cli () {
  docker run -it --rm \
    --log-driver none \
    --name redis-cli \
    jacknagel/redis-cli:latest \
    "$@"
}

eksctx () {
  region=$(aws configure get region)
  cluster=${1:-dev}
  aws eks update-kubeconfig --name "$cluster" --alias "${region}/${cluster}"
}

kctx () {
  kubectl config get-contexts -o name | fzy --query="${1}" | xargs kubectl config use-context
}

kns () {
  kubectl get namespaces -o name | cut -d/ -f2 | fzy --query="${1}" | xargs kubectl config set-context --current --namespace
}

krun () {
  kubectl run -it --rm "busybox_${USER}" --image=busybox:1.28 --restart=Never -- "${@:-sh}"
}
